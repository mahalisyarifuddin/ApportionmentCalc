<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1">
		<title>ApportionmentCalc</title>
		<style>
			:root {
				--primary: #0070ea;
				--hover: #005bc0;
				--bg: #f9f9ff;
				--surface: #fff;
				--text: #414754;
				--border: #c1c6d7;
				--dim: #d7d9e5;
				--success: #28a745;
				--danger: #dc3545
			}

			@media(prefers-color-scheme: dark) {
				:root:not(.light) {
					--bg:#10131b;
					--surface: #181c23;
					--text: #c1c6d7;
					--border: #414754;
					--dim: #10131b
				}
			}

			:root.dark {
				--bg: #10131b;
				--surface: #181c23;
				--text: #c1c6d7;
				--border: #414754;
				--dim: #10131b
			}

			* {
				box-sizing: border-box;
				margin: 0;
				padding: 0
			}

			*:focus-visible {
				outline: 2px solid var(--primary);
				outline-offset: 2px
			}

			body {
				background: var(--bg);
				color: var(--text);
				font-family: sans-serif;
				display: flex;
				justify-content: center;
				min-height: 100vh;
				padding: 1rem
			}

			.container {
				background: var(--surface);
				border: 1px solid var(--border);
				border-radius: 8px;
				max-width: 960px;
				padding: 2rem;
				width: 100%;
				position: relative;
				margin-top: 2rem;
				margin-bottom: 2rem
			}

			.hidden {
				display: none!important
			}

			h1,h2,h3,label {
				margin: .5rem 0
			}

			label {
				display: block;
				font-weight: 700
			}

			input,select,button {
				background: var(--surface);
				border: 1px solid var(--border);
				border-radius: 4px;
				color: var(--text);
				font-size: 1rem;
				padding: .5rem;
				width: 100%
			}

			button {
				cursor: pointer;
				transition: background .1s
			}

			button:disabled {
				background: var(--dim)!important;
				border-color: var(--border)!important;
				color: var(--text)!important;
				cursor: not-allowed;
				opacity: .6
			}

			.primary {
				background: var(--primary);
				color: #fff;
				border: 0
			}

			.primary:hover:not(:disabled) {
				background: var(--hover)
			}

			.secondary:hover:not(:disabled) {
				background: var(--dim)
			}

			.danger,.success {
				color: #fff;
				border: 0
			}

			.danger {
				background: var(--danger)
			}

			.success {
				background: var(--success)
			}

			.danger:hover,.success:hover {
				filter: brightness(.9)
			}

			.selectors {
				position: absolute;
				right: 2rem;
				top: 1rem;
				display: flex;
				gap: 8px
			}

			.selectors select {
				font-size: .9rem;
				padding: 5px;
				width: auto
			}

			.row {
				display: flex;
				gap: 1rem;
				margin-bottom: 1rem
			}

			.group {
				flex: 1
			}

			.party-list {
				display: block;
				margin-bottom: 1rem
			}

			.party-row {
				margin-bottom: .5rem;
				display: flex;
				gap: .5rem;
				align-items: center
			}

			.party-row input[type=text] {
				flex: 2
			}

			.party-row input[type=number] {
				flex: 1
			}

			.party-row button {
				width: auto;
				padding: .5rem 1rem
			}

			.results-grid {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 1rem;
				margin-top: 1rem
			}

			table {
				border-collapse: collapse;
				margin-top: 1rem;
				width: 100%;
				font-size: .9rem
			}

			th,td {
				border: 1px solid var(--border);
				padding: .5rem;
				text-align: left
			}

			th {
				background: var(--primary);
				color: #fff
			}

			.comparison {
				margin-top: 2rem;
				padding-top: 1rem;
				border-top: 1px solid var(--border)
			}

			.positive {
				color: var(--success);
				font-weight: 700
			}

			.negative {
				color: var(--danger);
				font-weight: 700
			}

			.neutral {
				opacity: .5
			}

			.step {
				background: var(--surface);
				border: 1px solid var(--border);
				margin-bottom: 1rem;
				padding: 1rem;
				border-radius: 4px
			}

			.highlight {
				background: rgba(0,112,234,.1);
				font-weight: bold
			}

			.error {
				color: #d32f2f;
				font-size: .9rem;
				margin-top: 1rem;
				margin-bottom: 1rem;
				display: block;
				font-weight: 500
			}

			#modal {
				position: fixed;
				inset: 0;
				background: rgba(0,0,0,.5);
				display: flex;
				justify-content: center;
				align-items: center;
				z-index: 1000
			}

			#content {
				background: var(--surface);
				padding: 2rem;
				border-radius: 8px;
				max-width: 90%;
				max-height: 90%;
				overflow-y: auto;
				width: 800px;
				position: relative
			}

			#close {
				position: absolute;
				top: 1rem;
				right: 1rem;
				width: auto;
				padding: .5rem 1rem
			}

			.actions {
				display: flex;
				gap: 1rem;
				margin-top: 1rem;
				flex-wrap: wrap
			}

			.actions button {
				flex: 1
			}

			.info {
				font-size: .9rem;
				opacity: .8;
				line-height: 1.6
			}

			#subtitle {
				margin-bottom: 1.5rem;
				opacity: .8
			}

			.stats {
				margin-top: 1rem;
				padding: 1rem;
				background: var(--surface);
				border: 1px solid var(--border);
				border-radius: 4px
			}

			.italic {
				font-style: italic
			}

			.step-header {
				margin-top: 2rem
			}

			@media(max-width: 768px) {
				.results-grid {
					grid-template-columns:1fr
				}

				.selectors {
					position: static;
					justify-content: flex-end;
					margin-bottom: .5rem
				}

				.row {
					flex-direction: column;
					gap: 1rem
				}
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="selectors">
				<select id="language">
					<option value="en">English</option>
					<option value="id">Bahasa Indonesia</option>
				</select>
				<select id="theme">
					<option value="auto"></option>
					<option value="light"></option>
					<option value="dark"></option>
				</select>
			</div>
			<h1 id="title"></h1>
			<p id="subtitle"></p>
			<div id="input">
				<div class="row">
					<div class="group">
						<label id="seatsLabel" for="seats"></label>
						<input type="number" id="seats" min="1" value="10">
					</div>
					<div class="group">
						<label id="thresholdLabel" for="threshold"></label>
						<input type="text" id="threshold" value="4">
					</div>
				</div>
				<div class="party-list" id="list"></div>
				<div class="row" style="gap:0.5rem;margin-bottom:1rem">
					<button id="add" class="secondary" style="flex:1"></button>
					<button id="clear" class="secondary" style="flex:1"></button>
					<button id="import" class="secondary" style="flex:1"></button>
				</div>
				<input type="file" id="file" accept=".csv,.tsv,.txt" class="hidden">
				<span id="error" class="error hidden" aria-live="polite"></span>
				<button id="calculate" class="primary"></button>
			</div>
			<div id="results" class="hidden">
				<div class="actions">
					<button id="edit" class="secondary"></button>
					<button id="steps" class="secondary"></button>
					<button id="export" class="success"></button>
				</div>
				<div id="stats" class="stats"></div>
				<div class="results-grid">
					<div>
						<h2 id="hareTitle"></h2>
						<div id="hare"></div>
					</div>
					<div>
						<h2 id="sainteLagueTitle"></h2>
						<div id="sainteLague"></div>
					</div>
				</div>
				<div class="comparison">
					<h2 id="compareTitle"></h2>
					<div id="compare"></div>
				</div>
			</div>
		</div>
		<div id="modal" class="hidden">
			<div id="content">
				<button id="close" class="secondary">×</button>
				<h2 id="modalTitle"></h2>
				<div id="modalSteps"></div>
			</div>
		</div>
		<script>
			const text = {
				en: {
					title: 'ApportionmentCalc',
					subtitle: 'Electoral seat allocation calculator: Sainte-Laguë vs Hare Quota',
					autoTheme: 'Auto Theme',
					lightTheme: 'Light',
					darkTheme: 'Dark',
					seatsLabel: 'Total Seats',
					thresholdLabel: 'Electoral Threshold (%)',
					add: '+ Add Party',
					calculate: 'Calculate Allocation',
					edit: 'Edit Inputs',
					steps: 'Show Sainte-Laguë Steps',
					export: 'Export to CSV',
					hareTitle: 'Hare Quota Method',
					sainteLagueTitle: 'Sainte-Laguë Method',
					compareTitle: 'Results Comparison',
					modalTitle: 'Sainte-Laguë Step-by-Step',
					party: 'Party',
					votes: 'Votes',
					seatsColumn: 'Seats',
					remainder: 'Remainder',
					diff: 'Diff',
					quota: 'Quota',
					totalVotes: 'Total Valid Votes',
					thresholdVotes: 'Threshold Votes',
					belowThreshold: 'Parties below threshold',
					partyPlaceholder: 'Party Name',
					votesPlaceholder: 'Votes',
					alertSeats: 'Total seats must be at least 1.',
					alertParties: 'Please add at least one party with votes.',
					round: 'Round',
					winner: 'Winner',
					quotient: 'Quotient',
					divisor: 'Divisor',
					seatAllocated: 'Seat #{n}',
					divisorsText: 'Divisors: 1, 3, 5, 7...',
					quotientDetail: 'Quotient Detail',
					detailsLimited: 'Showing details for the first {n} rounds only.',
					winnerPrefix: 'Winner: ',
					share: '%',
					passedHeader: 'Passed Threshold?',
					hareSeatsHeader: 'Hare Seats',
					sainteLagueSeatsHeader: 'Sainte-Laguë Seats',
					differenceHeader: 'Difference',
					yes: 'Yes',
					no: 'No',
					import: 'Import CSV/TSV',
					alertImport: 'Error importing file. Please ensure it is a valid CSV/TSV with "Party" and "Votes" columns.',
					clear: 'Clear All',
					clearConfirm: 'Are you sure you want to clear all parties?',
					removeParty: 'Remove Party',
					closeModal: 'Close Modal',
					languageLabel: 'Language',
					themeLabel: 'Theme'
				},
				id: {
					title: 'ApportionmentCalc',
					subtitle: 'Kalkulator alokasi kursi pemilu: Sainte-Laguë vs Kuota Hare',
					autoTheme: 'Tema Otomatis',
					lightTheme: 'Terang',
					darkTheme: 'Gelap',
					seatsLabel: 'Jumlah Kursi',
					thresholdLabel: 'Ambang Batas Parlemen (%)',
					add: '+ Tambah Partai',
					calculate: 'Hitung Alokasi',
					edit: 'Ubah Input',
					steps: 'Tampilkan Langkah Sainte-Laguë',
					export: 'Ekspor ke CSV',
					hareTitle: 'Metode Kuota Hare',
					sainteLagueTitle: 'Metode Sainte-Laguë',
					compareTitle: 'Perbandingan Hasil',
					modalTitle: 'Langkah-langkah Sainte-Laguë',
					party: 'Partai',
					votes: 'Suara',
					seatsColumn: 'Kursi',
					remainder: 'Sisa',
					diff: 'Selisih',
					quota: 'BPP (Bilangan Pembagi Pemilih)',
					totalVotes: 'Total Suara Sah',
					thresholdVotes: 'Suara Ambang Batas',
					belowThreshold: 'Partai di bawah ambang batas',
					partyPlaceholder: 'Nama Partai',
					votesPlaceholder: 'Jumlah Suara',
					alertSeats: 'Jumlah kursi harus minimal 1.',
					alertParties: 'Harap tambahkan setidaknya satu partai dengan suara.',
					round: 'Putaran',
					winner: 'Pemenang',
					quotient: 'Bilangan',
					divisor: 'Pembagi',
					seatAllocated: 'Kursi ke-{n}',
					divisorsText: 'Pembagi: 1, 3, 5, 7...',
					quotientDetail: 'Rincian Bilangan',
					detailsLimited: 'Menampilkan rincian untuk {n} putaran pertama saja.',
					winnerPrefix: 'Pemenang: ',
					share: '%',
					passedHeader: 'Lolos Ambang Batas?',
					hareSeatsHeader: 'Kursi Hare',
					sainteLagueSeatsHeader: 'Kursi Sainte-Laguë',
					differenceHeader: 'Selisih',
					yes: 'Ya',
					no: 'Tidak',
					import: 'Impor CSV/TSV',
					alertImport: 'Gagal mengimpor file. Pastikan format CSV/TSV valid dengan kolom "Partai" dan "Suara".',
					clear: 'Hapus Semua',
					clearConfirm: 'Apakah Anda yakin ingin menghapus semua partai?',
					removeParty: 'Hapus Partai',
					closeModal: 'Tutup Modal',
					languageLabel: 'Bahasa',
					themeLabel: 'Tema'
				}
			};

			const escape = t=>t.replace(/[&<>"']/g, c=>'&#' + c.charCodeAt(0) + ';');
			const dom = Object.fromEntries([...document.querySelectorAll('[id]')].map(e=>[e.id, e]));
			const STEPS_LIMIT = 50;

			class ApportionmentCalc {
				constructor() {
					this.parties = Object.entries({
						'Apple Party': 25000,
						'Blueberry Party': 15000,
						'Cherry Party': 9000,
						'Date Party': 5000,
						'Elderberry Party': 1500
					}).map(([name,votes],i)=>({
						id: i + 1,
						name,
						votes
					}));
					let theme = 'auto';
					let language = navigator.language?.startsWith('id') ? 'id' : 'en';
					try {
						const saved = JSON.parse(localStorage.getItem('apportionment_state'));
						if (saved) {
							this.parties = saved.parties || this.parties;
							if (saved.seats) dom.seats.value = saved.seats;
							if (saved.threshold) dom.threshold.value = saved.threshold;
							theme = saved.theme || theme;
							language = saved.language || language;
						}
					} catch {}
					this.nextIndex = (this.parties.length ? Math.max(...this.parties.map(p=>p.id)) : 0) + 1;
					this.data = null;
					this.bind();
					this.setTheme(theme);
					this.setLanguage(language);
				}

				saveState() {
					try {
						localStorage.setItem('apportionment_state', JSON.stringify({
							parties: this.parties,
							seats: dom.seats.value,
							threshold: dom.threshold.value,
							theme: dom.theme.value,
							language: dom.language.value
						}));
					} catch {}
				}

				bind() {
					const on = (element,event,handler)=>element[event] = handler;
					on(dom.add, 'onclick', ()=>this.addParty());
					on(dom.clear, 'onclick', ()=>this.clearAll());
					on(dom.calculate, 'onclick', ()=>this.calculate());
					on(dom.edit, 'onclick', ()=>this.show('input'));
					on(dom.steps, 'onclick', ()=>this.toggleModal(true));
					on(dom.close, 'onclick', ()=>this.toggleModal(false));
					on(dom.export, 'onclick', ()=>this.exportData());
					on(dom.import, 'onclick', ()=>dom.file.click());
					on(dom.file, 'onchange', e=>this.importData(e.target.files[0]));
					on(dom.modal, 'onclick', e=>e.target === dom.modal && this.toggleModal(false));
					on(dom.language, 'onchange', e=>this.setLanguage(e.target.value));
					on(dom.theme, 'onchange', e=>this.setTheme(e.target.value));
					dom.input.addEventListener('input', ()=>{
						this.toggleError();
						this.saveState();
					});
					dom.input.addEventListener('change', ()=>this.saveState());
					document.onkeydown = e=>this.handleKey(e);
					dom.list.addEventListener('click', e=>{
						const row = e.target.closest('.party-row');
						e.target.matches('.danger') && row && this.removeParty(+row.dataset.id);
					}
					);
					dom.list.addEventListener('change', e=>{
						const row = e.target.closest('.party-row');
						const party = row && this.parties.find(p=>p.id === +row.dataset.id);
						if (!party)
							return;
						if (e.target.type === 'text')
							party.name = e.target.value;
						else if (e.target.type === 'number')
							e.target.value = party.votes = Math.round(parseFloat(e.target.value)) || 0;
					}
					);
				}

				handleKey(event) {
					if (event.key === 'Escape' && !dom.modal.classList.contains('hidden'))
						this.toggleModal(false);
					if ((event.ctrlKey || event.metaKey) && event.key === 'Enter')
						this.calculate();
					const row = event.target.closest('.party-row');
					if (!event.ctrlKey && !event.metaKey && event.key === 'Enter' && row && event.target.matches('input')) {
						event.preventDefault();
						row.nextElementSibling ? row.nextElementSibling.querySelector('input')?.focus() : this.addParty();
					}
				}

				string(key) {
					return text[this.language]?.[key] ?? key;
				}
				format(value, options={}) {
					return value.toLocaleString(this.language === 'id' ? 'id-ID' : 'en-US', options);
				}
				table(headers, body) {
					return `<table><thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>${body}</tbody></table>`;
				}

				setTheme(theme) {
					document.documentElement.className = theme === 'auto' ? '' : theme;
					dom.theme.value = theme;
					this.saveState();
				}

				setLanguage(language) {
					this.language = dom.language.value = document.documentElement.lang = language;
					Object.keys(text.en).forEach(key=>dom[key] && !dom[key].matches('input,select') && (dom[key].textContent = this.string(key)));
					[...dom.theme.options].forEach(option=>option.textContent = this.string(option.value + 'Theme'));
					dom.close.setAttribute('aria-label', this.string('closeModal'));
					dom.language.setAttribute('aria-label', this.string('languageLabel'));
					dom.theme.setAttribute('aria-label', this.string('themeLabel'));
					this.renderParties();
					!dom.results.classList.contains('hidden') && this.data && this.renderResults();
					this.saveState();
				}

				show(section) {
					['input', 'results'].forEach(id=>dom[id].classList.toggle('hidden', id !== section));
				}

				toggleModal(visible) {
					dom.modal.classList.toggle('hidden', !visible);
					visible ? (this.lastFocus = document.activeElement,
					this.renderSteps(),
					dom.close.focus()) : this.lastFocus?.focus();
				}

				toggleError(message) {
					dom.error.textContent = message || '';
					dom.error.classList.toggle('hidden', !message);
					dom.calculate.disabled = !!message;
				}

				addParty() {
					this.toggleError();
					this.parties.push({
						id: this.nextIndex++,
						name: '',
						votes: 0
					});
					this.renderParties();
					dom.list.lastElementChild?.querySelector('input')?.focus();
					this.saveState();
				}

				clearAll() {
					if (!confirm(this.string('clearConfirm')))
						return;
					this.parties = [];
					this.renderParties();
					this.addParty();
					this.toggleError();
					this.saveState();
				}

				removeParty(id) {
					this.toggleError();
					const index = this.parties.findIndex(p=>p.id === id);
					this.parties = this.parties.filter(p=>p.id !== id);
					this.renderParties();
					const target = Math.min(index, this.parties.length - 1);
					target >= 0 ? dom.list.children[target]?.querySelector('.danger')?.focus() : dom.add.focus();
					this.saveState();
				}

				renderParties() {
					dom.list.innerHTML = this.parties.map(party=>`<div class="party-row" data-id="${party.id}"><input type="text" value="${escape(party.name)}" placeholder="${this.string('partyPlaceholder')}" aria-label="${this.string('partyPlaceholder')}"><input type="number" value="${party.votes || ''}" placeholder="${this.string('votesPlaceholder')}" min="0" aria-label="${this.string('votesPlaceholder')}"><button class="danger" aria-label="${this.string('removeParty')}">×</button></div>`).join('');
				}

				importData(file) {
					if (!file)
						return;
					const reader = new FileReader();
					reader.onload = e=>{
						try {
							const lines = e.target.result.split(/\r?\n/).filter(line=>line.trim());
							if (!lines.length)
								throw new Error();
							const delimiter = lines[0].split('\t').length > lines[0].split(',').length ? '\t' : ',';
							const parse = line=>line.split(new RegExp(`\\${delimiter}(?=(?:(?:[^"]*"){2})*[^"]*$)`)).map(c=>c.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
							const firstRow = parse(lines[0]);
							const isNumeric = c=>/^\d+$/.test(c.replace(/[.,]/g, '').trim());
							const match = (c,keys)=>keys.some(k=>c.toLowerCase().includes(k));
							let nameIndex = firstRow.findIndex(c=>match(c, ['party', 'partai', 'name', 'nama']));
							let voteIndex = firstRow.findIndex((c,i)=>i !== nameIndex && match(c, ['vote', 'suara']));
							let start = 1;
							if (nameIndex < 0 || voteIndex < 0) {
								voteIndex = firstRow.findIndex(isNumeric);
								nameIndex = firstRow.findIndex(c=>!isNumeric(c));
								if (nameIndex < 0 && voteIndex >= 0 && firstRow.length === 2)
									nameIndex = 1 - voteIndex;
								start = 0;
							}
							if (nameIndex === -1 || voteIndex === -1)
								throw new Error();
							const newParties = lines.slice(start).reduce((accumulator,line)=>{
								const columns = parse(line);
								const name = columns[nameIndex];
								const votes = parseInt((columns[voteIndex] || '').replace(/\D/g, '')) || 0;
								if (name && columns.length > Math.max(nameIndex, voteIndex))
									accumulator.push({
										id: this.nextIndex++,
										name,
										votes
									});
								return accumulator;
							}
							, []);
							if (!newParties.length)
								throw new Error();
							this.parties = newParties;
							this.toggleError();
							this.renderParties();
							dom.file.value = '';
							this.saveState();
						} catch {
							this.toggleError(this.string('alertImport'));
						}
					}
					;
					reader.readAsText(file);
				}

				calculate() {
					this.toggleError();
					const seats = parseInt(dom.seats.value);
					const threshold = parseFloat(dom.threshold.value.replace(',', '.')) || 0;
					if (isNaN(seats) || seats < 1)
						return this.toggleError(this.string('alertSeats'));
					const valid = this.parties.filter(p=>p.name && p.votes >= 0);
					const total = valid.reduce((sum,p)=>sum + p.votes, 0);
					if (!valid.length || total === 0)
						return this.toggleError(this.string('alertParties'));
					const thresholdVotes = total * threshold / 100;
					const passed = valid.filter(p=>p.votes >= thresholdVotes - 1e-7);
					if (!passed.length)
						return this.toggleError(this.string('belowThreshold'));
					const quota = total / seats;
					const hare = passed.map(p=>{
						const hareSeats = Math.floor((p.votes * seats) / total);
						return {
							...p,
							hareSeats,
							remainder: p.votes - hareSeats * quota
						};
					}
					);
					let allocated = hare.reduce((sum,p)=>sum + p.hareSeats, 0);
					hare.sort((a,b)=>b.remainder - a.remainder || b.votes - a.votes);
					for (let i = 0; i < seats - allocated; i++)
						hare[i].hareSeats++;
					const work = passed.map(p=>({
						...p,
						slSeats: 0,
						divisor: 1,
						quotient: p.votes
					}));
					const stepList = [];
					for (let i = 1; i <= seats; i++) {
						const winner = work.reduce((best,p)=>p.quotient > best.quotient || (p.quotient === best.quotient && p.votes > best.votes) ? p : best);
						stepList.push({
							round: i,
							winner: winner.name,
							winnerId: winner.id,
							winnerQuotient: winner.quotient,
							winnerDivisor: winner.divisor,
							quotients: i <= STEPS_LIMIT ? work.map(({id, name, quotient, divisor})=>({
								id,
								name,
								quotient,
								divisor
							})) : null
						});
						winner.slSeats++;
						winner.divisor += 2;
						winner.quotient = winner.votes / winner.divisor;
					}
					this.data = {
						total,
						thresholdVotes,
						threshold,
						seats,
						quota,
						steps: stepList,
						results: valid.map(p=>{
							const hareResult = hare.find(x=>x.id === p.id);
							const slResult = work.find(x=>x.id === p.id);
							return {
								...p,
								passed: p.votes >= thresholdVotes - 1e-7,
								hareSeats: hareResult?.hareSeats ?? 0,
								sainteLagueSeats: slResult?.slSeats ?? 0,
								remainder: hareResult?.remainder ?? 0
							};
						}
						)
					};
					this.renderResults();
					this.show('results');
				}

				renderResults() {
					if (!this.data)
						return;
					const {results, total, thresholdVotes, threshold, quota} = this.data;
					const passed = results.filter(r=>r.passed);
					const failed = results.filter(r=>!r.passed);
					const row = (r,seats,extra='')=>`<tr><td>${escape(r.name)}</td><td>${this.format(r.votes)}</td><td>${this.format(r.votes / total * 100, {
						maximumFractionDigits: 2
					})}%</td><td><strong>${seats}</strong></td>${extra}</tr>`;
					dom.stats.innerHTML = `<div class="info">${this.string('totalVotes')}: ${this.format(total)}<br>${this.string('thresholdVotes')} (${this.format(threshold)}%): ${this.format(thresholdVotes, {
						maximumFractionDigits: 0
					})}${failed.length ? `<br><span class="italic">${this.string('belowThreshold')}: ${failed.map(r=>`${escape(r.name)} (${this.format(r.votes)})`).join(', ')}</span>` : ''}</div>`;
					dom.hare.innerHTML = `<p class="info">${this.string('quota')}: ${this.format(quota)}</p>${this.table(['party', 'votes', 'share', 'seatsColumn', 'remainder'].map(k=>this.string(k)), [...passed].sort((a,b)=>b.hareSeats - a.hareSeats).map(r=>row(r, r.hareSeats, `<td>${this.format(r.remainder, {
						maximumFractionDigits: 6
					})}</td>`)).join(''))}`;
					dom.sainteLague.innerHTML = `<p class="info">${this.string('divisorsText')}</p>${this.table(['party', 'votes', 'share', 'seatsColumn'].map(k=>this.string(k)), [...passed].sort((a,b)=>b.sainteLagueSeats - a.sainteLagueSeats).map(r=>row(r, r.sainteLagueSeats)).join(''))}`;
					dom.compare.innerHTML = this.table([this.string('party'), 'Hare', 'Sainte-Laguë', this.string('diff')], [...passed].sort((a,b)=>b.votes - a.votes).map(r=>{
						const diff = r.sainteLagueSeats - r.hareSeats;
						return `<tr><td>${escape(r.name)}</td><td>${r.hareSeats}</td><td>${r.sainteLagueSeats}</td><td class="${diff > 0 ? 'positive' : diff < 0 ? 'negative' : 'neutral'}">${diff > 0 ? '+' : ''}${diff}</td></tr>`;
					}
					).join(''));
				}

				renderSteps() {
					const {steps} = this.data;
					if (!steps?.length)
						return;
					const details = steps.slice(0, STEPS_LIMIT);
					const warning = steps.length > STEPS_LIMIT ? `<p class="info" style="margin-top:1rem;font-style:italic">${this.string('detailsLimited').replace('{n}', STEPS_LIMIT)}</p>` : '';
					const seatTemplate = this.string('seatAllocated');
					const winnerPrefix = this.string('winnerPrefix');
					const options = {
						maximumFractionDigits: 2
					};
					dom.modalSteps.innerHTML = this.table(['round', 'winner', 'quotient', 'divisor'].map(k=>this.string(k)), steps.map(s=>`<tr><td>${seatTemplate.replace('{n}', s.round)}</td><td><strong>${escape(s.winner)}</strong></td><td>${this.format(s.winnerQuotient, options)}</td><td>${s.winnerDivisor}</td></tr>`).join('')) + `<h3 class="step-header">${this.string('quotientDetail')}</h3>${warning}${details.map(s=>s.quotients ? `<div class="step"><h4>${seatTemplate.replace('{n}', s.round)} - ${winnerPrefix}${escape(s.winner)}</h4>${this.table(s.quotients.map(q=>`${escape(q.name)} (/${q.divisor})`), `<tr>${s.quotients.map(q=>`<td class="${q.id === s.winnerId ? 'highlight' : ''}">${this.format(q.quotient, options)}</td>`).join('')}</tr>`)}</div>` : '').join('')}${warning}`;
				}

				exportData() {
					if (!this.data)
						return;
					const {results} = this.data;
					const total = results.reduce((sum,p)=>sum + p.votes, 0);
					const header = [this.string('party'), this.string('votes'), this.string('share'), this.string('passedHeader'), this.string('hareSeatsHeader'), this.string('sainteLagueSeatsHeader'), this.string('differenceHeader')].join(',');
					const csv = header + '\n' + results.map(r=>`"${r.name.replace(/"/g, '""')}",${r.votes},"${this.format(r.votes / total * 100, {
						minimumFractionDigits: 2,
						maximumFractionDigits: 2
					})}",${r.passed ? this.string('yes') : this.string('no')},${r.hareSeats},${r.sainteLagueSeats},${r.sainteLagueSeats - r.hareSeats}`).join('\n');
					const anchor = document.createElement('a');
					anchor.href = URL.createObjectURL(new Blob([csv],{
						type: 'text/csv'
					}));
					anchor.download = `apportionment_${new Date().toISOString().slice(0, 19).replace(/[T:]/g, '-')}.csv`;
					anchor.click();
				}
			}

			new ApportionmentCalc();
		</script>
	</body>
</html>
