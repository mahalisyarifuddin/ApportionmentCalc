<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>ApportionmentCalc</title>
	<style>
		:root {
			--primary: #005dac;
			--on-primary: #ffffff;
			--hover: #00539a;
			--background: #f9f9ff;
			--surface: #ffffff;
			--text: #181c21;
			--border: #c1c6d4;
			--muted: #f2f3fc;
			--success: #0b6b1d;
			--on-success: #ffffff;
			--danger: #ba1a1a;
			--on-danger: #ffffff;
			--highlight-bg: #d4e3ff;
		}
		@media (prefers-color-scheme: dark) {
			:root:not(.light) {
				--primary: #a5c8ff;
				--on-primary: #00315f;
				--hover: #72adff;
				--background: #101319;
				--surface: #0b0e14;
				--text: #e0e2ea;
				--border: #414752;
				--muted: #181c21;
				--success: #82db7e;
				--on-success: #00390a;
				--danger: #ffb4ab;
				--on-danger: #93000a;
				--highlight-bg: #001c3a;
			}
		}
		:root.dark {
			--primary: #a5c8ff;
			--on-primary: #00315f;
			--hover: #72adff;
			--background: #101319;
			--surface: #0b0e14;
			--text: #e0e2ea;
			--border: #414752;
			--muted: #181c21;
			--success: #82db7e;
			--on-success: #00390a;
			--danger: #ffb4ab;
			--on-danger: #93000a;
			--highlight-bg: #001c3a;
		}
		* { 
			box-sizing: border-box; 
			margin: 0; 
			padding: 0; 
			outline-offset: 2px; 
		}
		*:focus-visible { 
			outline: 2px solid var(--primary); 
		}
		body {
			background: var(--background);
			color: var(--text);
			font-family: sans-serif;
			font-variant-numeric: tabular-nums;
			display: flex;
			justify-content: center;
			min-height: 100vh;
			padding: 1rem;
		}
		.container {
			background: var(--surface);
			border: 1px solid var(--border);
			border-radius: 8px;
			max-width: 960px;
			padding: 2rem;
			width: 100%;
			position: relative;
			margin: 2rem 0;
		}
		.hidden { 
			display: none !important; 
		}
		h1, h2, h3, label { 
			margin: .5rem 0; 
		}
		label { 
			display: block; 
			font-weight: 700; 
		}
		input, select, button {
			background: var(--surface);
			border: 1px solid var(--border);
			border-radius: 4px;
			color: var(--text);
			font-size: 1rem;
			padding: .5rem;
			width: 100%;
		}
		input[type="number"],
		#threshold {
			text-align: right;
		}
		button { 
			cursor: pointer; 
		}
		button:disabled { 
			opacity: .6; 
			cursor: not-allowed; 
		}
		.primary { 
			background: var(--primary); 
			color: var(--on-primary); 
			border: 0; 
		}
		.primary:hover:not(:disabled) { 
			background: var(--hover); 
		}
		.secondary:hover:not(:disabled) { 
			background: var(--muted); 
		}
		.danger, .success { 
			color: var(--on-danger); 
			border: 0; background: 
			var(--danger); 
		}
		.success { 
			background: var(--success); 
			color: var(--on-success); 
		}
		.danger:hover, .success:hover { 
			filter: brightness(.9); 
		}
		.selectors {
			position: absolute;
			right: 2rem;
			top: 1rem;
			display: flex;
			gap: 8px;
		}
		.selectors select { 
			width: auto; 
			font-size: .9rem; 
		}
		#list, #inputStats {
			margin-bottom: 1rem;
		}
		#inputStats {
			text-align: right;
		}
		.row { 
			display: flex; 
			gap: 1rem; 
			margin-bottom: 1rem; 
		}
		.group { 
			flex: 1; 
		}
		.party-row {
			display: flex;
			gap: .5rem;
			align-items: center;
			margin-bottom: .5rem;
		}
		.party-row input[type=text] { 
			flex: 2; 
		}
		.party-row input[type=number] { 
			flex: 1; 
		}
		.party-row button { 
			width: auto; 
			padding: .5rem 1rem; 
		}
		.results-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 1rem;
			margin-top: 1rem;
		}
		.results-grid > div { 
			min-width: 0; 
		}
		#hare, #sainteLague, #compare { 
			overflow-x: auto; 
		}
		table { 
			border-collapse: collapse; 
			margin-top: 1rem; 
			width: 100%; 
			font-size: .9rem; 
		}
		th, td { 
			border: 1px solid var(--border); 
			padding: .5rem; 
			text-align: left; 
		}
		#results th:not(:first-child),
		#results td:not(:first-child) {
			text-align: right;
		}
		th { 
			background: var(--primary); 
			color: var(--on-primary); 
		}
		.comparison {
			margin-top: 2rem;
			padding-top: 1rem;
			border-top: 1px solid var(--border);
		}
		.positive { 
			color: var(--success); 
			font-weight: 700; 
		}
		.negative { 
			color: var(--danger); 
			font-weight: 700; 
		}
		.step {
			border: 1px solid var(--border);
			margin-bottom: 1rem;
			padding: 1rem;
			border-radius: 4px;
			overflow-x: auto;
		}
		.highlight { 
			background: var(--highlight-bg); 
			font-weight: 700; 
		}
		.error {
			color: var(--danger);
			font-size: .9rem;
			margin: 1rem 0;
			display: block;
			font-weight: 500;
		}
		.failed-party { 
			opacity: 0.6; 
			background: var(--muted); 
		}
		.hide-failed .failed-party { 
			display: none; 
		}
		dialog {
			background: var(--surface);
			color: var(--text);
			border: 1px solid var(--border);
			border-radius: 8px;
			padding: 1.5rem;
			max-width: 800px;
			max-height: 90%;
			width: 100%;
			margin: auto;
			position: fixed;
			overflow-y: auto;
		}
		dialog::backdrop { 
			background: rgba(0, 0, 0, 0.5); 
		}
		.dialog-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 1.5rem;
		}
		.dialog-header h2 { 
			margin: 0; 
			font-size: 1.5rem; 
		}
		.close-button {
			background: transparent;
			color: var(--text);
			padding: .25rem;
			font-size: 1.5rem;
			line-height: 1;
			border: 0;
			width: auto;
			cursor: pointer;
		}
		.close-button:hover { 
			background: var(--muted); 
			color: var(--text); 
		}
		.actions { 
			display: flex; 
			gap: 1rem; 
			margin-top: 
			1rem; 
			flex-wrap: wrap; 
		}
		.actions button { 
			min-width: 160px; 
		}
		.info { 
			font-size: .9rem; 
			opacity: .8; 
			line-height: 1.6; 
		}
		.stats { 
			margin-top: 1rem; 
			padding: 1rem; 
			border: 1px solid var(--border); 
			border-radius: 4px; 
		}
		.flex-align-center { display: flex; align-items: center; }
		.gap-sm { gap: .5rem; }
		.mt-sm { margin-top: .5rem; }
		.mt-md { margin-top: 1rem; }
		.mt-lg { margin-top: 2rem; }
		.font-normal { font-weight: 400; }
		.text-sm { font-size: .9rem; }
		.w-auto { width: auto; }
		.m-0 { margin: 0; }
		.flex-1 { flex: 1; }
		.italic { font-style: italic; }
		.gradient-bar {
			background: linear-gradient(90deg, var(--highlight-bg) var(--percentage), transparent var(--percentage));
		}
		@media(max-width: 768px) {
			.results-grid { 
				grid-template-columns: 1fr; 
			}
			.selectors { 
				position: static; 
				justify-content: end; 
				margin-bottom: .5rem; 
			}
			.row { 
				flex-direction: column; 
			}
		}
		body.drag-active::after {
			content: "";
			position: fixed;
			inset: 0;
			background: var(--highlight-bg);
			border: 4px dashed var(--primary);
			opacity: 0.9;
			z-index: 9999;
			pointer-events: none;
		}
	</style>
</head>
<body>
	<div class="container">
		<div class="selectors">
			<select id="language"><option value="en">English</option><option value="id">Bahasa Indonesia</option></select>
			<select id="theme"><option value="auto"></option><option value="light"></option><option value="dark"></option></select>
		</div>
		<h1 id="title"></h1>
		<p id="subtitle" class="info"></p>
		<div id="input">
			<div class="row">
				<div class="group">
					<label id="seatsLabel" for="seats"></label>
					<input type="number" id="seats" min="1" value="10">
				</div>
				<div class="group">
					<label id="thresholdLabel" for="threshold"></label>
					<input type="text" id="threshold" value="4">
					<label class="flex-align-center gap-sm mt-sm font-normal text-sm">
						<input type="checkbox" id="hide" class="w-auto m-0">
						<span id="hideLabel"></span>
					</label>
				</div>
			</div>
			<div id="list"></div>
			<div id="inputStats" class="info"></div>
			<div class="row gap-sm">
				<button id="add" class="secondary flex-1"></button>
				<button id="clear" class="secondary flex-1"></button>
				<button id="import" class="secondary flex-1"></button>
			</div>
			<input type="file" id="file" accept=".csv,.tsv,.txt" class="hidden">
			<span id="error" class="error hidden" aria-live="polite"></span>
			<button id="calculate" class="primary"></button>
		</div>
		<div id="results" class="hidden">
			<div class="actions">
				<button id="edit" class="secondary flex-1"></button>
				<button id="steps" class="secondary flex-1"></button>
				<button id="copy" class="secondary flex-1"></button>
				<button id="export" class="success flex-1"></button>
			</div>
			<div id="stats" class="stats"></div>
			<div class="results-grid">
				<div><h2 id="hareTitle"></h2><div id="hare"></div></div>
				<div><h2 id="sainteLagueTitle"></h2><div id="sainteLague"></div></div>
			</div>
			<div class="comparison">
				<h2 id="compareTitle"></h2>
				<div id="compare"></div>
			</div>
		</div>
	</div>
	<dialog id="modal">
		<div class="dialog-header">
			<h2 id="modalTitle"></h2>
			<button id="close" class="close-button">×</button>
		</div>
		<div id="modalSteps"></div>
	</dialog>
	<script>
		const text = {
			en: {
				title: 'ApportionmentCalc',
				subtitle: 'Electoral seat allocation calculator: Sainte-Lagu\u00eb vs Hare Quota',
				autoTheme: 'Auto Theme',
				lightTheme: 'Light',
				darkTheme: 'Dark',
				seatsLabel: 'Total Seats',
				thresholdLabel: 'Electoral Threshold (%)',
				hideLabel: 'Hide parties below threshold',
				add: '+ Add Party',
				calculate: 'Calculate Allocation',
				edit: 'Edit Inputs',
				steps: 'Show Sainte-Lagu\u00eb Steps',
				export: 'Export to CSV',
				hareTitle: 'Hare Quota Method',
				sainteLagueTitle: 'Sainte-Lagu\u00eb Method',
				compareTitle: 'Results Comparison',
				modalTitle: 'Sainte-Lagu\u00eb Step-by-Step',
				party: 'Party',
				votes: 'Votes',
				seatsColumn: 'Seats',
				remainder: 'Remainder',
				diff: 'Diff',
				quota: 'Quota',
				totalVotes: 'Total Valid Votes',
				thresholdVotes: 'Threshold Votes',
				belowThreshold: 'Parties below threshold',
				partyPlaceholder: 'Party Name',
				votesPlaceholder: 'Votes',
				alertSeats: 'Total seats must be at least 1.',
				alertParties: 'Please add at least one party with votes.',
				round: 'Round',
				winner: 'Winner',
				quotient: 'Quotient',
				divisor: 'Divisor',
				seatAllocated: 'Seat #{n}',
				divisorsText: 'Divisors: 1, 3, 5, 7...',
				quotientDetail: 'Quotient Detail',
				detailsLimited: 'Showing details for the first {n} rounds only.',
				summaryLimited: 'Showing first {n} rounds only.',
				winnerPrefix: 'Winner: ',
				share: '%',
				passedHeader: 'Passed Threshold?',
				hareSeatsHeader: 'Hare Seats',
				sainteLagueSeatsHeader: 'Sainte-Lagu\u00eb Seats',
				differenceHeader: 'Difference',
				yes: 'Yes',
				no: 'No',
				import: 'Import CSV/TSV',
				alertImport: 'Error importing file. Please ensure it is a valid CSV/TSV with "Party" and "Votes" columns.',
				clear: 'Clear All',
				clearConfirm: 'Are you sure you want to clear all parties?',
				removeParty: 'Remove Party',
				closeModal: 'Close Modal',
				languageLabel: 'Language',
				themeLabel: 'Theme',
				gallagher: 'Gallagher Index',
				copy: 'Copy Results',
				copied: 'Copied!'
			},
			id: {
				title: 'ApportionmentCalc',
				subtitle: 'Kalkulator alokasi kursi pemilu: Sainte-Lagu\u00eb vs Kuota Hare',
				autoTheme: 'Tema Otomatis',
				lightTheme: 'Terang',
				darkTheme: 'Gelap',
				seatsLabel: 'Jumlah Kursi',
				thresholdLabel: 'Ambang Batas Parlemen (%)',
				hideLabel: 'Sembunyikan partai di bawah ambang batas',
				add: '+ Tambah Partai',
				calculate: 'Hitung Alokasi',
				edit: 'Ubah Input',
				steps: 'Tampilkan Langkah Sainte-Lagu\u00eb',
				export: 'Ekspor ke CSV',
				hareTitle: 'Metode Kuota Hare',
				sainteLagueTitle: 'Metode Sainte-Lagu\u00eb',
				compareTitle: 'Perbandingan Hasil',
				modalTitle: 'Langkah-langkah Sainte-Lagu\u00eb',
				party: 'Partai',
				votes: 'Suara',
				seatsColumn: 'Kursi',
				remainder: 'Sisa',
				diff: 'Selisih',
				quota: 'BPP (Bilangan Pembagi Pemilih)',
				totalVotes: 'Total Suara Sah',
				thresholdVotes: 'Suara Ambang Batas',
				belowThreshold: 'Partai di bawah ambang batas',
				partyPlaceholder: 'Nama Partai',
				votesPlaceholder: 'Jumlah Suara',
				alertSeats: 'Jumlah kursi harus minimal 1.',
				alertParties: 'Harap tambahkan setidaknya satu partai dengan suara.',
				round: 'Putaran',
				winner: 'Pemenang',
				quotient: 'Bilangan',
				divisor: 'Pembagi',
				seatAllocated: 'Kursi ke-{n}',
				divisorsText: 'Pembagi: 1, 3, 5, 7...',
				quotientDetail: 'Rincian Bilangan',
				detailsLimited: 'Menampilkan rincian untuk {n} putaran pertama saja.',
				summaryLimited: 'Menampilkan {n} putaran pertama saja.',
				winnerPrefix: 'Pemenang: ',
				share: '%',
				passedHeader: 'Lolos Ambang Batas?',
				hareSeatsHeader: 'Kursi Hare',
				sainteLagueSeatsHeader: 'Kursi Sainte-Lagu\u00eb',
				differenceHeader: 'Selisih',
				yes: 'Ya',
				no: 'Tidak',
				import: 'Impor CSV/TSV',
				alertImport: 'Gagal mengimpor file. Pastikan format CSV/TSV valid dengan kolom "Partai" dan "Suara".',
				clear: 'Hapus Semua',
				clearConfirm: 'Apakah Anda yakin ingin menghapus semua partai?',
				removeParty: 'Hapus Partai',
				closeModal: 'Tutup Modal',
				languageLabel: 'Bahasa',
				themeLabel: 'Tema',
				gallagher: 'Indeks Gallagher',
				copy: 'Salin Hasil',
				copied: 'Tersalin!'
			}
		};
		const elements = new Proxy({},{ get: (_,id)=>document.getElementById(id) });
		const STEPS_LIMIT = 50;
		const SUMMARY_LIMIT = 1000;

		class ApportionmentCalc {
			constructor() {
				(this.parties = [],
				this.setup(),
				this.theme('auto'),
				this.language = navigator.language?.startsWith('id') ? 'id' : 'en',
				this.lang(this.language),
				this.loadState()
					? this.calculate()
					: (this.parties = Object.entries({
							Apple: 25000,
							Blueberry: 15000,
							Cherry: 9000,
							Date: 5000,
							Elderberry: 1500
						}).map(([n,v],i)=>({ id: i + 1,name: n + ' Party',votes: v })),
						this.nextIndex = 6,
						this.renderParties()),
				window.onhashchange = ()=>this.loadState() && this.calculate())
			}

			loadState() {
				try {
					return !location.hash
						? false
						: (s=> (
							!s?.seats || !s?.parties?.length
								? false
								: (elements.seats.value = s.seats,
									elements.threshold.value = s.threshold ?? 0,
									elements.hide.checked = !!s.hide,
									this.parties = s.parties.map((p,i)=>({ id: i + 1,name: p.name || '',votes: p.votes || 0 })),
									this.nextIndex = this.parties.length + 1,
									this.renderParties(),
									true)
						)) (JSON.parse(decodeURIComponent(location.hash.slice(1))))
				} catch(e) {
					return false
				}
			}

			saveState() {
				(s=> (
					(h=> (location.hash !== '#' + h && (location.hash = h))) (encodeURIComponent(JSON.stringify(s)))
				)) ({
					seats: elements.seats.value,
					threshold: elements.threshold.value,
					hide: elements.hide.checked,
					parties: this.parties.map(({ name,votes })=>({ name,votes }))
				})
			}

			setup() {
				(Object.entries({
					add: ()=>this.add(),
					clear: ()=>this.clear(),
					calculate: ()=>this.calculate(),
					edit: ()=>this.display('input'),
					steps: ()=>this.modal(true),
					close: ()=>this.modal(false),
					copy: ()=>this.copy(),
					export: ()=>this.export(),
					import: ()=>elements.file.click()
				}).forEach(([id,h])=>elements[id] && (elements[id].onclick = h)),
				elements.file.onchange = e=>this.load(e.target.files[0]),
				elements.modal.onclick = e=>(r=> ( (r.top <= e.clientY && e.clientY <= r.top + r.height && r.left <= e.clientX && e.clientX <= r.left + r.width) || this.modal(false) )) (elements.modal.getBoundingClientRect()),
				elements.modal.addEventListener('close',()=>this.lastFocus?.focus()),
				elements.language.onchange = e=>this.lang(e.target.value),
				elements.theme.onchange = e=>this.theme(e.target.value),
				elements.input.oninput = ()=>(this.error(),this.updateInputStats()),
				document.onkeydown = e=>this.key(e),
				elements.list.onclick = e=>(r=> ( r && e.target.matches('.danger') && this.remove(+r.dataset.id) )) (e.target.closest('.party-row')),
				elements.list.onchange = e=>(r=> ( (p=> ( p && (e.target.type === 'text' ? p.name = e.target.value : e.target.value = p.votes = Math.max(0,Math.round(+e.target.value) || 0)) )) (r && this.parties.find(p=>p.id === +r.dataset.id)) )) (e.target.closest('.party-row')),
				(c=> (
					(document.body.ondragenter = e=>(e.preventDefault(),c++,document.body.classList.add('drag-active')),
					document.body.ondragleave = e=>(c--,c === 0 && document.body.classList.remove('drag-active')),
					document.body.ondragover = e=>e.preventDefault(),
					document.body.ondrop = e=>(e.preventDefault(),c = 0,document.body.classList.remove('drag-active'),(f=>f && this.load(f))(e.dataTransfer.files[0])))
				)) (0))
			}

			key(e) {
				((e.ctrlKey || e.metaKey) && e.key === 'Enter' && this.calculate(),
				(r=> ( !e.ctrlKey && !e.metaKey && e.key === 'Enter' && r && e.target.matches('input') && (
					e.preventDefault(),
					(p=> ( p && (e.target.type === 'text' ? p.name = e.target.value : p.votes = Math.max(0,Math.round(+e.target.value) || 0)) )) (this.parties.find(p=>p.id === +r.dataset.id)),
					e.target.type === 'text' ? e.target.nextElementSibling?.focus() : r.nextElementSibling ? r.nextElementSibling.querySelector('input')?.focus() : this.add()
				) )) (e.target.closest('.party-row')))
			}

			string(k) { return text[this.language]?.[k] ?? k }
			format(v,o = {}) { return v.toLocaleString(this.language === 'id' ? 'id-ID' : 'en-US',o) }
			escapeHtml(s) { return (s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;') }
			table(h,b) { return `<table><thead><tr>${h.map(x=>`<th scope="col">${x}</th>`).join('')}</tr></thead><tbody>${b}</tbody></table>` }

			theme(n) {
				(document.documentElement.className = n === 'auto' ? '' : n,
				elements.theme.value = n)
			}

			lang(l) {
				(this.language = elements.language.value = document.documentElement.lang = l,
				Object.keys(text.en).forEach(k=>elements[k] && (elements[k].textContent = this.string(k))),
				[...elements.theme.options].forEach(o=>o.textContent = this.string(o.value + 'Theme')),
				[['close','closeModal'],['language','languageLabel'],['theme','themeLabel']]
					.forEach(([i,k])=>elements[i].setAttribute('aria-label',this.string(k))),
				this.renderParties(),
				!elements.results.classList.contains('hidden') && this.data && this.renderResults())
			}

			display(s) {
				(['input','results'].forEach(i=>elements[i].classList.toggle('hidden',i !== s)),
				s === 'results' ? (elements.results.setAttribute('tabindex','-1'),elements.results.focus()) : elements.seats.focus())
			}

			modal(v) {
				v ? (this.lastFocus = document.activeElement,this.renderSteps(),elements.modal.showModal()) : elements.modal.close()
			}

			error(m) {
				(elements.error.textContent = m || '',
				elements.error.classList.toggle('hidden',!m))
			}

			add() {
				(this.error(),
				this.parties.push({ id: this.nextIndex++,name: '',votes: 0 }),
				this.renderParties(),
				elements.list.lastElementChild?.querySelector('input')?.focus())
			}

			clear() {
				confirm(this.string('clearConfirm')) && (
					this.parties = [],
					this.renderParties(),
					this.add(),
					this.error()
				)
			}

			remove(i) {
				(this.error(),
				(idx=> (
					this.parties = this.parties.filter(p=>p.id !== i),
					this.renderParties(),
					(t=> ( t >= 0 ? elements.list.children[t]?.querySelector('.danger')?.focus() : elements.add.focus() )) (Math.min(idx,this.parties.length - 1))
				)) (this.parties.findIndex(p=>p.id === i)))
			}

			updateInputStats() {
				(v=> (
					(t=> (
						(m=> (
							elements.inputStats.innerHTML = `${this.string('totalVotes')}: <strong>${this.format(v)}</strong> | ${this.string('thresholdVotes')} (${this.format(t)}%): <strong>${this.format(m,{ maximumFractionDigits: 2 })}</strong>`
						)) (v * t / 100)
					)) (parseFloat(elements.threshold.value.replace(',','.')) || 0)
				)) ([...elements.list.querySelectorAll('input[type=number]')]
					.reduce((s,i)=>s + Math.max(0,parseInt(i.value) || 0),0))
			}

			renderParties() {
				(elements.list.innerHTML = this.parties
					.map((p,i)=>`
						<div class="party-row" data-id="${p.id}">
							<input type="text" value="${this.escapeHtml(p.name)}" placeholder="${this.string('partyPlaceholder')}" aria-label="${this.string('partyPlaceholder')} ${i + 1}">
							<input type="number" value="${p.votes || ''}" placeholder="${this.string('votesPlaceholder')}" min="0" aria-label="${this.string('votesPlaceholder')} ${i + 1}">
							<button class="danger" aria-label="${this.string('removeParty')} ${i + 1}">×</button>
						</div>
					`).join(''),
				this.updateInputStats())
			}

			load(f) {
				(r=> (r.onload = e=>{
					try {
						this.parseCSV(e.target.result),
						elements.file.value = ''
					} catch(err) {
						this.error(this.string('alertImport'))
					}
				},r.readAsText(f))) (new FileReader())
			}

			parseNumber(s) {
				return (v=> (n=> ( Math.max(0,Math.round(n) || 0) )) (parseFloat(v))) (!s
					? '0'
					: s.trim()
						.replace(/\s/g,'')
						.replace(this.language === 'id' ? /\./g : /,/g,'')
						.replace(this.language === 'id' ? /,/ : /\./,'.'))
			}

			parseCSV(t) {
				(l=> (
				  !l.length ? (()=>{throw new Error()})() :
				  (s=> (
					(p=> (
					  (h=> (
						(is=> (
						  (ni=> (
							(v_idx=> (
							  (st=> (
								( ((ni < 0 || v_idx < 0) && (st = 0,v_idx = h.findIndex(is),ni = (v_idx >= 0 && h.length === 2) ? 1 - v_idx : h.findIndex(c=>!is(c)))),
								  ni < 0 || v_idx < 0 ? (()=>{throw new Error()})() : (ps=> ( !ps.length ? (()=>{throw new Error()})() : (this.parties = ps,this.error(),this.renderParties()) )) ( l.slice(st)
									.map(ln=> (c=> !c[ni] ? null : ({id:this.nextIndex++,name:c[ni],votes:this.parseNumber(c[v_idx])}))(p(ln)))
									.filter(Boolean) ) )
							  )) (1)
							)) (h.findIndex(c=>/vote|suara/i.test(c)))
						  )) (h.findIndex(c=>/party|partai|name|nama/i.test(c)))
						)) (c=>/^\d+$/.test(c?.replace(/[.,]/g,'').trim()))
					  )) (p(l[0]))
					)) (ln=>ln.split(new RegExp(`\\${s}(?=(?:(?:[^"]*"){2})*[^"]*$)`))
						.map(c=>c.trim().replace(/^"|"$/g,'').replace(/""/g,'"')))
				  )) (l[0].includes('\t')&&l[0].split('\t').length>l[0].split(',').length?'\t':',')
				)) (t.split(/\r?\n/).filter(ln=>ln.trim()))
			}

			calculate() {
				(this.error(),
				this.parties = this.parties.filter(p=>p.name.trim() || p.votes > 0),
				this.renderParties(),
				(s=> (
					(t=> ( isNaN(s) || s < 1
						? this.error(this.string('alertSeats'))
						: (res=> ( res.error
								? this.error(this.string(res.error))
								: (this.saveState(),this.data = res.data,this.renderResults(),this.display('results'))
							)) (this.computeAllocation(s,t,this.parties))
					)) (parseFloat(elements.threshold.value.replace(',','.')) || 0)
				)) (parseInt(elements.seats.value)))
			}

			computeAllocation(s,t,ps) {
				return (v=> (
					(tot=> ( tot === 0 ? { error: 'alertParties' } : (m=> (
						(passed=> ( !passed.length ? { error: 'belowThreshold' } : (pt=> (
							(q=> (
								(passed.forEach(p=>(p.hare = Math.floor(p.votes * s / pt),p.remainder = (p.votes * s % pt) / pt,p.divisor = 1,p.quotient = p.votes)),
								(rem=> ( rem.slice(0,s - passed.reduce((sum,p)=>sum + p.hare,0)).forEach(p=>p.hare++) )) ([...passed].sort((a,b)=>b.remainder - a.remainder || b.votes - a.votes)),
								(steps=> (
									([...Array(s)].forEach((_,i)=>(w=> (
										(i < SUMMARY_LIMIT && steps.push({ round: i + 1,winner: w.name,winnerId: w.id,value: w.quotient,divisor: w.divisor,all: i < STEPS_LIMIT ? passed.map(({ id,name,quotient,divisor })=>({ id,name,quotient,divisor })) : null })),
										w.sainteLague++,w.divisor += 2,w.quotient = w.votes / w.divisor
									)) (passed.reduce((best,p)=>p.quotient > best.quotient || (p.quotient === best.quotient && p.votes > best.votes) ? p : best)))),
									(res=> (cg=> ({ data: { total: tot,minimumVotes: m,threshold: t,seats: s,quota: q,steps,results: res,hareIndex: cg('hare'),sainteLagueIndex: cg('sainteLague') } })) (k=> Math.sqrt(0.5 * v.reduce((sum,p)=>sum + Math.pow((p.votes / tot * 100) - (p[k] / s * 100),2),0)))) (v.map(p=>({ ...p,passed: p.votes >= m - 1e-7 })))
								)) ([]))
							)) (pt / s)
						)) (passed.reduce((sum,p)=>sum + p.votes,0))
					)) (v.filter(p=>p.votes >= m - 1e-7)) )) (tot * t / 100) )) (v.reduce((sum,p)=>sum + p.votes,0))
				)) (ps.filter(p=>p.votes >= 0 && (p.name || p.votes > 0))
					.map(p=>({ ...p,name: p.name || `${this.string('party')} ${p.id}`,hare: 0,sainteLague: 0,remainder: 0 })))
			}

			renderResults() {
				this.data && (
					(elements.results.classList.toggle('hide-failed',elements.hide.checked),
					(d=> (
						(r=> (
							(elements.stats.innerHTML = `<div class="info">${this.string('totalVotes')}: ${this.format(d.total)}<br>${this.string('thresholdVotes')} (${this.format(d.threshold)}%): ${this.format(d.minimumVotes,{ maximumFractionDigits: 2 })}</div>`,
							elements.hare.innerHTML = `<p class="info">${this.string('quota')}: ${this.format(d.quota)} | ${this.string('gallagher')}: ${this.format(d.hareIndex,{ maximumFractionDigits: 4 })}</p>`
								+ this.table([...['party','votes','share','seatsColumn'].map(k=>this.string(k)),this.string('remainder')], [...d.results]
									.sort((a,b)=>b.hare - a.hare || b.votes - a.votes)
									.map(res=>r(res,res.hare,`<td>${this.format(res.remainder,{ maximumFractionDigits: 6 })}</td>`))
									.join('')),
							elements.sainteLague.innerHTML = `<p class="info">${this.string('divisorsText')} | ${this.string('gallagher')}: ${this.format(d.sainteLagueIndex,{ maximumFractionDigits: 4 })}</p>`
								+ this.table(['party','votes','share','seatsColumn'].map(k=>this.string(k)), [...d.results]
									.sort((a,b)=>b.sainteLague - a.sainteLague || b.votes - a.votes)
									.map(res=>r(res,res.sainteLague))
									.join('')),
							elements.compare.innerHTML = this.table([this.string('party'),this.string('votes'),this.string('share'),'Hare','Sainte-Lagu\u00eb',this.string('diff')], [...d.results]
								.sort((a,b)=>b.votes - a.votes)
								.map(res=>(diff=> ( `<tr class="${res.passed ? '' : 'failed-party'}"><td role="rowheader">${this.escapeHtml(res.name)}</td><td>${this.format(res.votes)}</td><td>${this.format(res.votes / d.total * 100,{ maximumFractionDigits: 2 })}%</td><td>${res.hare}</td><td>${res.sainteLague}</td><td class="${diff > 0 ? 'positive' : diff < 0 ? 'negative' : 'neutral'}">${diff > 0 ? '+' : ''}${diff}</td></tr>` )) (res.sainteLague - res.hare))
								.join('')))
						)) ((res,count,extra = '')=> (pct=> ( `<tr class="${res.passed ? '' : 'failed-party'}"><td role="rowheader">${this.escapeHtml(res.name)}</td><td>${this.format(res.votes)}</td><td class="gradient-bar" style="--percentage:${pct}%">${this.format(pct,{ maximumFractionDigits: 2 })}%</td><td><strong>${count}</strong></td>${extra}</tr>` )) (res.votes / d.total * 100))
					)) (this.data))
				)
			}

			renderSteps() {
				(d=> d?.steps?.length && (
				  (sum=> (
					(sumW=> (
					  (det=> (
						(detW=> (
						  (st=> (
							(wp=> (
							  (opt=> (
								(elements.modalSteps.innerHTML = this.table(['round','winner','quotient','divisor'].map(k=>this.string(k)),sum
									.map(s=>`<tr><td>${st.replace('{n}',s.round)}</td><td><strong>${this.escapeHtml(s.winner)}</strong></td><td>${this.format(s.value,opt)}</td><td>${s.divisor}</td></tr>`).join(''))
									+ sumW + `<h3 class="mt-lg">${this.string('quotientDetail')}</h3>${detW}`
									+ det.map(s=>s.all
										? `<div class="step"><h4>${st.replace('{n}',s.round)} - ${wp}${this.escapeHtml(s.winner)}</h4>`
											+ this.table(s.all.map(q=>`${this.escapeHtml(q.name)} (/${q.divisor})`),`<tr>${s.all.map(q=>`<td class="${q.id === s.winnerId ? 'highlight' : ''}">${this.format(q.quotient,opt)}</td>`).join('')}</tr>`)
											+ '</div>'
										: '').join('')
									+ detW)
							  )) ({ minimumFractionDigits: 2,maximumFractionDigits: 6 })
							)) (this.string('winnerPrefix'))
						  )) (this.string('seatAllocated'))
						)) (d.steps.length > STEPS_LIMIT ? `<p class="info mt-md italic">${this.string('detailsLimited').replace('{n}',STEPS_LIMIT)}</p>` : '')
					  )) (d.steps.slice(0,STEPS_LIMIT))
					)) (d.seats > SUMMARY_LIMIT ? `<p class="info mt-md italic">${this.string('summaryLimited').replace('{n}',SUMMARY_LIMIT)}</p>` : '')
				  )) (d.steps.slice(0,SUMMARY_LIMIT))
				)) (this.data)
			}

			copy() {
				this.data && (r=> (
				  (t=> (
					(h=> (
					  (tsv=> (
						navigator.clipboard.writeText(tsv)
							.then(()=>(b=> (b.textContent = this.string('copied'),setTimeout(()=>b.textContent = this.string('copy'), 2000))) (elements.copy))
					  )) ( [h,...r.map(res=>[res.name,res.votes,this.format(res.votes / t * 100,{ maximumFractionDigits: 2 }) + '%',res.hare,res.sainteLague,res.sainteLague - res.hare].join('\t'))].join('\n') )
					)) ( [this.string('party'),this.string('votes'),this.string('share'),this.string('hareSeatsHeader'),this.string('sainteLagueSeatsHeader'),this.string('diff')].join('\t') )
				  )) ( r.reduce((sum,p)=>sum + p.votes,0) )
				)) (this.data.results)
			}

			export() {
				this.data && (r=> (
				  (t=> (
					(h=> (
					  (csv=> (
						Object.assign(document.createElement('a'), {
							href: URL.createObjectURL(new Blob([csv],{ type: 'text/csv' })),
							download: `apportionment_${new Date().toISOString().slice(0,19).replace(/[T:]/g,'-')}.csv`
						}).click()
					  )) ( [h,...r.map(res=>`"${res.name.replace(/"/g,'""')}",${res.votes},"${this.format(res.votes / t * 100,{ minimumFractionDigits: 2,maximumFractionDigits: 2 })}",${res.passed ? this.string('yes') : this.string('no')},${res.hare},${res.sainteLague},${res.sainteLague - res.hare}`)].join('\n') )
					)) ( [this.string('party'),this.string('votes'),this.string('share'),this.string('passedHeader'),this.string('hareSeatsHeader'),this.string('sainteLagueSeatsHeader'),this.string('differenceHeader')].join(',') )
				  )) ( r.reduce((sum,p)=>sum + p.votes,0) )
				)) (this.data.results)
			}
		}
		new ApportionmentCalc();
</script>
</body>
</html>
