<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1.0">
		<title>ApportionmentCalc</title>
		<style>
			:root {
				--primary: #0070ea;
				--primary-hover: #005bc0;
				--background: #f9f9ff;
				--surface: #fff;
				--text: #414754;
				--border: #c1c6d7;
				--hover: #d7d9e5;
				--success: #28a745;
				--danger: #dc3545;
			}

			@media (prefers-color-scheme: dark) {
				:root:not(.light) {
					--background: #10131b;
					--surface: #181c23;
					--text: #c1c6d7;
					--border: #414754;
					--hover: #10131b;
				}
			}

			:root.dark {
				--background: #10131b;
				--surface: #181c23;
				--text: #c1c6d7;
				--border: #414754;
				--hover: #10131b;
			}

			* {
				box-sizing: border-box;
				margin: 0;
				padding: 0;
			}

			body {
				background: var(--background);
				color: var(--text);
				font-family: sans-serif;
				display: flex;
				align-items: flex-start;
				justify-content: center;
				min-height: 100vh;
				padding: 1rem;
			}

			.container {
				background: var(--surface);
				border: 1px solid var(--border);
				border-radius: 8px;
				max-width: 1000px;
				padding: 2rem;
				width: 100%;
				position: relative;
				margin-top: 2rem;
			}

			.hidden {
				display: none !important;
			}

			h1, h2, h3 {
				margin: 0.5rem 0;
			}

			label {
				display: block;
				font-weight: 700;
				margin-bottom: 0.5rem;
			}

			input, select, textarea, button {
				background: var(--surface);
				border: 1px solid var(--border);
				border-radius: 4px;
				color: var(--text);
				font-size: 1rem;
				padding: 0.5rem;
				width: 100%;
			}

			button {
				cursor: pointer;
				transition: background 0.2s;
			}

			.primary {
				background: var(--primary);
				border: none;
				color: #fff;
			}

			.primary:hover {
				background: var(--primary-hover);
			}

			.secondary:hover {
				background: var(--hover);
			}

			.danger {
				background: var(--danger);
				color: #fff;
				border: none;
			}

			.danger:hover {
				filter: brightness(0.9);
			}

			.success {
				background: var(--success);
				color: #fff;
				border: none;
			}

			.success:hover {
				filter: brightness(0.9);
			}

			.selectors {
				position: absolute;
				right: 2rem;
				top: 1rem;
				display: flex;
				gap: 8px;
			}

			.selectors select {
				font-size: 0.9rem;
				padding: 5px;
				width: auto;
			}

			.row {
				display: flex;
				gap: 1rem;
				margin-bottom: 1rem;
			}

			.group {
				flex: 1;
				margin-bottom: 1rem;
			}

			.party-list {
				margin-bottom: 1rem;
			}

			.party-row {
				display: flex;
				gap: 0.5rem;
				margin-bottom: 0.5rem;
				align-items: center;
			}

			.party-row input[type="text"] {
				flex: 2;
			}

			.party-row input[type="number"] {
				flex: 1;
			}

			.party-row button {
				width: auto;
				padding: 0.5rem 1rem;
			}

			.results-grid {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 1rem;
				margin-top: 1rem;
			}

			table {
				border-collapse: collapse;
				margin-top: 1rem;
				width: 100%;
				font-size: 0.9rem;
			}

			th, td {
				border: 1px solid var(--border);
				padding: 0.5rem;
				text-align: left;
			}

			th {
				background: var(--primary);
				color: #fff;
			}

			.comparison-section {
				margin-top: 2rem;
				padding-top: 1rem;
				border-top: 1px solid var(--border);
			}

			.diff-positive {
				color: var(--success);
				font-weight: bold;
			}

			.diff-negative {
				color: var(--danger);
				font-weight: bold;
			}

			.diff-neutral {
				color: var(--text);
				opacity: 0.5;
			}

			.viz-step {
				background: var(--surface);
				border: 1px solid var(--border);
				margin-bottom: 1rem;
				padding: 1rem;
				border-radius: 4px;
			}

			.viz-step h4 {
				margin-top: 0;
			}

			.viz-row-highlight {
				background-color: rgba(0, 112, 234, 0.1);
			}

			#vizModal {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0,0,0,0.5);
				display: flex;
				justify-content: center;
				align-items: center;
				z-index: 1000;
			}

			#vizContent {
				background: var(--surface);
				padding: 2rem;
				border-radius: 8px;
				max-width: 90%;
				max-height: 90%;
				overflow-y: auto;
				width: 800px;
				position: relative;
			}

			#closeViz {
				position: absolute;
				top: 1rem;
				right: 1rem;
				width: auto;
				font-size: 1.5rem;
				padding: 0.25rem 0.75rem;
			}

			.action-buttons {
				display: flex;
				gap: 1rem;
				margin-top: 1rem;
				flex-wrap: wrap;
			}

			.action-buttons button {
				flex: 1;
			}

			.info-text {
				font-size: 0.9rem;
				opacity: 0.8;
				margin-bottom: 0.5rem;
			}

			@media (max-width: 768px) {
				.results-grid {
					grid-template-columns: 1fr;
				}

				.selectors {
					position: static;
					justify-content: flex-end;
					margin-bottom: 0.5rem;
					gap: 4px;
				}

				.row {
					flex-direction: column;
					gap: 0;
				}

				.spacer {
					display: none;
				}
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="selectors">
				<select id="language">
					<option value="en">English</option>
					<option value="id">Bahasa Indonesia</option>
				</select>
				<select id="theme">
					<option value="auto"></option>
					<option value="light"></option>
					<option value="dark"></option>
				</select>
			</div>
			<h1 id="title"></h1>
			<p id="subtitle" style="margin-bottom: 1.5rem; opacity: 0.8;"></p>
			<div id="input">
				<div class="row">
					<div class="group">
						<label id="seatsLabel" for="seats"></label>
						<input type="number" id="seats" min="1" value="10">
					</div>
					<div class="group">
						<label id="thresholdLabel" for="threshold"></label>
						<input type="number" id="threshold" min="0" max="100" step="0.1" value="4">
					</div>
				</div>
				<div class="party-list" id="partyList"></div>
				<button id="addParty" class="secondary" style="margin-bottom: 1rem;"></button>
				<button id="calculate" class="primary"></button>
			</div>
			<div id="results" class="hidden">
				<div class="action-buttons">
					<button id="edit" class="secondary"></button>
					<button id="showViz" class="secondary"></button>
					<button id="export" class="success"></button>
				</div>
				<div class="results-grid">
					<div>
						<h2 id="hareTitle"></h2>
						<div id="hareResults"></div>
					</div>
					<div>
						<h2 id="sainteLagueTitle"></h2>
						<div id="sainteLagueResults"></div>
					</div>
				</div>
				<div class="comparison-section">
					<h2 id="comparisonTitle"></h2>
					<div id="comparisonResults"></div>
				</div>
			</div>
		</div>
		<div id="vizModal" class="hidden">
			<div id="vizContent">
				<button id="closeViz" class="secondary">×</button>
				<h2 id="vizTitle"></h2>
				<div id="vizSteps"></div>
			</div>
		</div>
		<script>
			const strings = {
				en: {
					title: 'ApportionmentCalc',
					subtitle: 'Electoral seat allocation calculator: Sainte Laguë vs Hare Quota',
					autoTheme: 'Auto Theme',
					lightTheme: 'Light',
					darkTheme: 'Dark',
					seatsLabel: 'Total Seats',
					thresholdLabel: 'Electoral Threshold (%)',
					addParty: '+ Add Party',
					calculate: 'Calculate Allocation',
					edit: 'Edit Inputs',
					showViz: 'Show Sainte Laguë Steps',
					export: 'Export to CSV',
					hareTitle: 'Hare Quota Method',
					sainteLagueTitle: 'Sainte Laguë Method',
					comparisonTitle: 'Results Comparison',
					vizTitle: 'Sainte Laguë Step-by-Step',
					party: 'Party',
					votes: 'Votes',
					seatsCol: 'Seats',
					remainder: 'Remainder',
					diff: 'Diff',
					quota: 'Quota',
					totalVotes: 'Total Valid Votes',
					thresholdVotes: 'Threshold Votes',
					belowThreshold: 'Parties below threshold',
					partyPlaceholder: 'Party Name',
					votesPlaceholder: 'Votes',
					alertSeats: 'Total seats must be at least 1.',
					alertParties: 'Please add at least one party with votes.',
					round: 'Round',
					winner: 'Winner',
					quotient: 'Quotient',
					divisor: 'Divisor',
					seatAllocated: 'Seat #{n}',
					divisorsText: 'Divisors: 1, 3, 5, 7...',
					quotientDetail: 'Quotient Detail',
					winnerPrefix: 'Winner: ',
				},
				id: {
					title: 'ApportionmentCalc',
					subtitle: 'Kalkulator alokasi kursi pemilu: Sainte Laguë vs Kuota Hare',
					autoTheme: 'Tema Otomatis',
					lightTheme: 'Terang',
					darkTheme: 'Gelap',
					seatsLabel: 'Jumlah Kursi',
					thresholdLabel: 'Ambang Batas Parlemen (%)',
					addParty: '+ Tambah Partai',
					calculate: 'Hitung Alokasi',
					edit: 'Ubah Input',
					showViz: 'Tampilkan Langkah Sainte Laguë',
					export: 'Ekspor ke CSV',
					hareTitle: 'Metode Kuota Hare',
					sainteLagueTitle: 'Metode Sainte Laguë',
					comparisonTitle: 'Perbandingan Hasil',
					vizTitle: 'Langkah-langkah Sainte Laguë',
					party: 'Partai',
					votes: 'Suara',
					seatsCol: 'Kursi',
					remainder: 'Sisa',
					diff: 'Selisih',
					quota: 'BPP (Bilangan Pembagi Pemilih)',
					totalVotes: 'Total Suara Sah',
					thresholdVotes: 'Suara Ambang Batas',
					belowThreshold: 'Partai di bawah ambang batas',
					partyPlaceholder: 'Nama Partai',
					votesPlaceholder: 'Jumlah Suara',
					alertSeats: 'Jumlah kursi harus minimal 1.',
					alertParties: 'Harap tambahkan setidaknya satu partai dengan suara.',
					round: 'Putaran',
					winner: 'Pemenang',
					quotient: 'Bilangan',
					divisor: 'Pembagi',
					seatAllocated: 'Kursi ke-{n}',
					divisorsText: 'Pembagi: 1, 3, 5, 7...',
					quotientDetail: 'Rincian Bilangan',
					winnerPrefix: 'Pemenang: ',
				}
			};

			const escape = text=>Object.assign(document.createElement('p'), {
				textContent: text
			}).innerHTML;

			class ApportionmentCalc {
				constructor() {
					this.el = Object.fromEntries([...document.querySelectorAll('[id]')].map(e=>[e.id, e]));
					this.parties = [{
						id: 1,
						name: 'Apple Party',
						votes: 25000
					}, {
						id: 2,
						name: 'Banana Party',
						votes: 15000
					}, {
						id: 3,
						name: 'Cherry Party',
						votes: 9000
					}, {
						id: 4,
						name: 'Date Party',
						votes: 5000
					}, {
						id: 5,
						name: 'Elderberry Party',
						votes: 1500
					}];
					this.nextId = 6;
					this.data = null;
					this.lang = navigator.language?.startsWith('id') ? 'id' : 'en';
					this.init();
				}

				init() {
					this.bind();
					this.renderParties();
					this.setTheme('auto');
					this.setLanguage(this.lang);
				}

				bind() {
					const {el} = this;
					el.addParty.onclick = ()=>this.addParty();
					el.calculate.onclick = ()=>this.calculate();
					el.edit.onclick = ()=>this.show('input');
					el.showViz.onclick = ()=>this.toggleViz(true);
					el.closeViz.onclick = ()=>this.toggleViz(false);
					el.vizModal.onclick = e=>e.target === el.vizModal && this.toggleViz(false);
					el.export.onclick = ()=>this.exportCsv();
					el.language.onchange = e=>this.setLanguage(e.target.value);
					el.theme.onchange = e=>this.setTheme(e.target.value);
				}

				t(key) {
					return strings[this.lang][key] || key;
				}

				fmt(key, values) {
					let text = this.t(key);
					for (const [k,v] of Object.entries(values || {}))
						text = text.replace(`{${k}}`, v);
					return text;
				}

				setTheme(theme) {
					document.documentElement.classList.remove('light', 'dark');
					if (theme !== 'auto')
						document.documentElement.classList.add(theme);
					this.el.theme.value = theme;
				}

				setLanguage(lang) {
					this.lang = lang;
					this.el.language.value = lang;
					document.documentElement.lang = lang;
					const {el} = this;
					const s = strings[lang];
					el.title.textContent = s.title;
					el.subtitle.textContent = s.subtitle;
					el.theme.options[0].textContent = s.autoTheme;
					el.theme.options[1].textContent = s.lightTheme;
					el.theme.options[2].textContent = s.darkTheme;
					el.seatsLabel.textContent = s.seatsLabel;
					el.thresholdLabel.textContent = s.thresholdLabel;
					el.addParty.textContent = s.addParty;
					el.calculate.textContent = s.calculate;
					el.edit.textContent = s.edit;
					el.showViz.textContent = s.showViz;
					el.export.textContent = s.export;
					el.hareTitle.textContent = s.hareTitle;
					el.sainteLagueTitle.textContent = s.sainteLagueTitle;
					el.comparisonTitle.textContent = s.comparisonTitle;
					el.vizTitle.textContent = s.vizTitle;
					this.renderParties();
					if (!el.results.classList.contains('hidden') && this.data)
						this.renderResults();
				}

				show(section) {
					['input', 'results'].forEach(id=>this.el[id].classList.toggle('hidden', id !== section));
				}

				toggleViz(show) {
					this.el.vizModal.classList.toggle('hidden', !show);
					if (show)
						this.renderViz();
				}

				addParty() {
					this.parties.push({
						id: this.nextId++,
						name: '',
						votes: 0
					});
					this.renderParties();
				}

				removeParty(id) {
					this.parties = this.parties.filter(p=>p.id !== id);
					this.renderParties();
				}

				renderParties() {
					const container = this.el.partyList;
					container.innerHTML = '';
					this.parties.forEach(party=>{
						const row = document.createElement('div');
						row.className = 'party-row';
						const name = Object.assign(document.createElement('input'), {
							type: 'text',
							placeholder: this.t('partyPlaceholder'),
							value: party.name,
							onchange: e=>party.name = e.target.value
						});
						const votes = Object.assign(document.createElement('input'), {
							type: 'number',
							placeholder: this.t('votesPlaceholder'),
							value: party.votes || '',
							min: '0',
							onchange: e=>party.votes = parseInt(e.target.value) || 0
						});
						const remove = Object.assign(document.createElement('button'), {
							className: 'danger',
							textContent: '×',
							onclick: ()=>this.removeParty(party.id)
						});
						row.append(name, votes, remove);
						container.appendChild(row);
					}
					);
				}

				calculate() {
					const totalSeats = parseInt(this.el.seats.value);
					const thresholdPct = parseFloat(this.el.threshold.value) || 0;
					if (totalSeats < 1)
						return alert(this.t('alertSeats'));
					const valid = this.parties.filter(p=>p.name && p.votes >= 0);
					if (!valid.length)
						return alert(this.t('alertParties'));

					const totalVotes = valid.reduce((s,p)=>s + p.votes, 0);
					const thresholdVotes = totalVotes * thresholdPct / 100;
					const passed = valid.filter(p=>p.votes >= thresholdVotes);
					const failed = valid.filter(p=>p.votes < thresholdVotes);
					if (!passed.length)
						return alert(this.t('belowThreshold'));

					const quota = passed.reduce((s,p)=>s + p.votes, 0) / totalSeats;
					let hare = passed.map(p=>({
						...p,
						hareSeats: Math.floor(p.votes / quota),
						remainder: p.votes % quota
					}));
					let allocated = hare.reduce((s,p)=>s + p.hareSeats, 0);
					hare.sort((a,b)=>b.remainder - a.remainder);
					for (let i = 0; i < totalSeats - allocated; i++)
						if (hare[i])
							hare[i].hareSeats++;

					let sl = passed.map(p=>({
						...p,
						slSeats: 0
					}));
					const steps = [];
					for (let i = 1; i <= totalSeats; i++) {
						let max = -1
						  , winner = -1;
						const quotients = sl.map((p,idx)=>{
							const divisor = 2 * p.slSeats + 1;
							const quotient = p.votes / divisor;
							if (quotient > max) {
								max = quotient;
								winner = idx;
							}
							return {
								id: p.id,
								name: p.name,
								quotient,
								divisor
							};
						}
						);
						if (winner !== -1) {
							sl[winner].slSeats++;
							steps.push({
								round: i,
								winner: sl[winner].name,
								winnerId: sl[winner].id,
								winningQuotient: max,
								quotients
							});
						}
					}

					this.data = {
						totalVotes,
						thresholdVotes,
						thresholdPct,
						totalSeats,
						quota,
						steps,
						results: valid.map(p=>{
							const h = hare.find(x=>x.id === p.id);
							const s = sl.find(x=>x.id === p.id);
							return {
								...p,
								passed: p.votes >= thresholdVotes,
								hareSeats: h?.hareSeats || 0,
								slSeats: s?.slSeats || 0,
								remainder: h?.remainder || 0
							};
						}
						)
					};
					this.renderResults();
					this.show('results');
				}

				renderResults() {
					if (!this.data)
						return;
					const {results, totalVotes, thresholdVotes, thresholdPct, quota} = this.data;
					const passed = results.filter(r=>r.passed);
					const failed = results.filter(r=>!r.passed);
					const fmt = (n,d=2)=>n.toLocaleString(undefined, {
						maximumFractionDigits: d
					});

					this.el.hareResults.innerHTML = `
					<p class="info-text">${this.t('quota')}: ${fmt(quota)}</p>
					<p class="info-text">${this.t('totalVotes')}: ${totalVotes.toLocaleString()}</p>
					<p class="info-text">${this.t('thresholdVotes')} (${thresholdPct}%): ${fmt(thresholdVotes, 0)}</p>
					<table><thead><tr><th>${this.t('party')}</th><th>${this.t('votes')}</th><th>${this.t('seatsCol')}</th><th>${this.t('remainder')}</th></tr></thead>
					<tbody>${[...passed].sort((a,b)=>b.hareSeats - a.hareSeats).map(r=>`<tr><td>${escape(r.name)}</td><td>${r.votes.toLocaleString()}</td><td><strong>${r.hareSeats}</strong></td><td>${fmt(r.remainder, 0)}</td></tr>`).join('')}</tbody></table>
					${failed.length ? `<p class="info-text" style="margin-top:0.5rem;font-style:italic;">${this.t('belowThreshold')}: ${failed.map(p=>escape(p.name)).join(', ')}</p>` : ''}`;

					this.el.sainteLagueResults.innerHTML = `
					<p class="info-text">${this.t('divisorsText')}</p><p class="info-text spacer">&nbsp;</p><p class="info-text spacer">&nbsp;</p>
					<table><thead><tr><th>${this.t('party')}</th><th>${this.t('votes')}</th><th>${this.t('seatsCol')}</th></tr></thead>
					<tbody>${[...passed].sort((a,b)=>b.slSeats - a.slSeats).map(r=>`<tr><td>${escape(r.name)}</td><td>${r.votes.toLocaleString()}</td><td><strong>${r.slSeats}</strong></td></tr>`).join('')}</tbody></table>`;

					this.el.comparisonResults.innerHTML = `
					<table><thead><tr><th>${this.t('party')}</th><th>Hare</th><th>Sainte-Laguë</th><th>${this.t('diff')}</th></tr></thead>
					<tbody>${[...results].sort((a,b)=>b.votes - a.votes).map(r=>{
						const diff = r.slSeats - r.hareSeats;
						const cls = diff > 0 ? 'diff-positive' : diff < 0 ? 'diff-negative' : 'diff-neutral';
						return `<tr><td>${escape(r.name)}${!r.passed ? ` ( < ${thresholdPct}%)` : ''}</td><td>${r.hareSeats}</td><td>${r.slSeats}</td><td class="${cls}">${diff > 0 ? '+' : ''}${diff}</td></tr>`;
					}
					).join('')}</tbody></table>`;
				}

				renderViz() {
					const {steps} = this.data;
					if (!steps?.length)
						return;
					const fmt = n=>n.toLocaleString(undefined, {
						maximumFractionDigits: 2
					});
					this.el.vizSteps.innerHTML = `
					<table><thead><tr><th>${this.t('round')}</th><th>${this.t('winner')}</th><th>${this.t('quotient')}</th><th>${this.t('divisor')}</th></tr></thead>
					<tbody>${steps.map(s=>`<tr><td>${this.fmt('seatAllocated', {
						n: s.round
					})}</td><td><strong>${escape(s.winner)}</strong></td><td>${fmt(s.winningQuotient)}</td><td>${s.quotients.find(q=>q.id === s.winnerId).divisor}</td></tr>`).join('')}</tbody></table>
					<h3 style="margin-top:2rem">${this.t('quotientDetail')}</h3>
					${steps.map(s=>`<div class="viz-step"><h4>${this.fmt('seatAllocated', {
						n: s.round
					})} - ${this.t('winnerPrefix')}${escape(s.winner)}</h4>
					<table><tr>${s.quotients.map(q=>`<th>${escape(q.name)} (/${q.divisor})</th>`).join('')}</tr>
					<tr>${s.quotients.map(q=>`<td class="${q.id === s.winnerId ? 'viz-row-highlight' : ''}" style="${q.id === s.winnerId ? 'font-weight:bold' : ''}">${fmt(q.quotient)}</td>`).join('')}</tr></table></div>`).join('')}`;
				}

				exportCsv() {
					if (!this.data)
						return;
					const {results} = this.data;
					const total = results.reduce((s,p)=>s + p.votes, 0);
					const csv = 'Party,Votes,Share (%),Passed Threshold?,Hare Seats,Sainte-Laguë Seats,Difference\n' + results.map(r=>`"${r.name.replace(/"/g, '""')}",${r.votes},${(r.votes / total * 100).toFixed(2)},${r.passed ? 'Yes' : 'No'},${r.hareSeats},${r.slSeats},${r.slSeats - r.hareSeats}`).join('\n');
					const link = Object.assign(document.createElement('a'), {
						href: URL.createObjectURL(new Blob([csv],{
							type: 'text/csv'
						})),
						download: `apportionment_${new Date().toISOString().slice(0, 19).replace(/[T:]/g, '-')}.csv`
					});
					link.click();
				}
			}

			new ApportionmentCalc();
		</script>
	</body>
</html>
